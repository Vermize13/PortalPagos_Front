<p-sidebar #sidebarRef [visible]="!collapsed" [modal]="false" [dismissible]="false" [showCloseIcon]="false"
  [closeOnEscape]="false" [styleClass]="collapsed ? 'collapsed-sidebar' : ''" (onHide)="toggleCollapsed()"
  [baseZIndex]="1200">
  <ng-template pTemplate="headless">
    <div class="flex h-full flex-column">
      <div class="flex flex-shrink-0 px-4 pt-3 align-items-center justify-content-between">
        <span class="inline-flex gap-2 align-items-center">
          <span class="text-2xl font-semibold text-primary"><img src="../../../assets/img/martinierelogo.png"
              alt="Martiniere Logo" width="100px"></span>
        </span>
        <span>
          <p-button type="button" (onClick)="toggleCollapsed()" icon="pi pi-angle-double-left" rounded="true"
            outlined="true" styleClass="h-2rem w-2rem"></p-button>
        </span>
      </div>
      <div class="overflow-y-auto">
        <ul class="p-3 m-0 list-none">
          <li>
            <a pRipple [routerLink]="['home']" routerLinkActive="active-menu-item"
              class="flex p-3 transition-colors cursor-pointer align-items-center border-round text-700 hover:surface-100 transition-duration-150 p-ripple">
              <i class="mr-2 pi pi-home"></i>
              <span class="font-medium">Inicio</span>
            </a>
          </li>
          <li *ngIf="canViewDashboard()">
            <a pRipple [routerLink]="['dashboard']" routerLinkActive="active-menu-item"
              class="flex p-3 transition-colors cursor-pointer align-items-center border-round text-700 hover:surface-100 transition-duration-150 p-ripple">
              <i class="mr-2 pi pi-chart-bar"></i>
              <span class="font-medium">Dashboard</span>
            </a>
          </li>
        </ul>

        <ul class="p-3 m-0 list-none" *ngIf="canSeeManagementSection()">
          <li>
            <div pRipple pStyleClass="@next" enterClass="hidden" enterActiveClass="slidedown" leaveToClass="hidden"
              leaveActiveClass="slideup"
              class="flex p-3 cursor-pointer align-items-center justify-content-between text-600 p-ripple">
              <span class="font-medium"><b>Gestión</b></span>
              <i class="pi pi-chevron-down"></i>
            </div>
            <ul class="p-0 m-0 overflow-hidden list-none">
              <li *ngIf="canViewIncidents()">
                <a pRipple [routerLink]="['incidents']" routerLinkActive="active-menu-item"
                  class="flex p-3 transition-colors cursor-pointer align-items-center border-round text-700 hover:surface-100 transition-duration-150 p-ripple">
                  <i class="mr-2 pi pi-exclamation-circle"></i>
                  <span class="font-medium">Incidencias</span>
                </a>
              </li>
              <li *ngIf="canViewProjects()">
                <a pRipple [routerLink]="['projects']" routerLinkActive="active-menu-item"
                  class="flex p-3 transition-colors cursor-pointer align-items-center border-round text-700 hover:surface-100 transition-duration-150 p-ripple">
                  <i class="mr-2 pi pi-folder"></i>
                  <span class="font-medium">Proyectos</span>
                </a>
              </li>
              <li *ngIf="canViewUsers()">
                <a pRipple [routerLink]="['users']" routerLinkActive="active-menu-item"
                  class="flex p-3 transition-colors cursor-pointer align-items-center border-round text-700 hover:surface-100 transition-duration-150 p-ripple">
                  <i class="mr-2 pi pi-users"></i>
                  <span class="font-medium">Usuarios</span>
                </a>
              </li>
            </ul>
          </li>
        </ul>

        <ul class="p-3 m-0 list-none" *ngIf="canSeeAdminSection()">
          <li>
            <div pRipple pStyleClass="@next" enterClass="hidden" enterActiveClass="slidedown" leaveToClass="hidden"
              leaveActiveClass="slideup"
              class="flex p-3 cursor-pointer align-items-center justify-content-between text-600 p-ripple">
              <span class="font-medium"><b>Administración</b></span>
              <i class="pi pi-chevron-down"></i>
            </div>
            <ul class="p-0 m-0 overflow-hidden list-none">
              <li *ngIf="canViewAudit()">
                <a pRipple [routerLink]="['audit']" routerLinkActive="active-menu-item"
                  class="flex p-3 transition-colors cursor-pointer align-items-center border-round text-700 hover:surface-100 transition-duration-150 p-ripple">
                  <i class="mr-2 pi pi-history"></i>
                  <span class="font-medium">Auditoría</span>
                </a>
              </li>
              <li *ngIf="canAccessAdmin()">
                <a pRipple [routerLink]="['admin']" routerLinkActive="active-menu-item"
                  class="flex p-3 transition-colors cursor-pointer align-items-center border-round text-700 hover:surface-100 transition-duration-150 p-ripple">
                  <i class="mr-2 pi pi-cog"></i>
                  <span class="font-medium">Administración del Sistema</span>
                </a>
              </li>
            </ul>
          </li>
        </ul>
      </div>
      <!-- Profile section at bottom -->
      <div class="flex-shrink-0 p-3 profile-section border-top-1 border-200" *ngIf="currentUser as user">
        <div
          class="flex gap-3 p-2 cursor-pointer align-items-center border-round hover:surface-100 transition-duration-150"
          (click)="toggleProfileMenu($event)" (keydown.enter)="toggleProfileMenu($event)"
          (keydown.space)="toggleProfileMenu($event); $event.preventDefault()" tabindex="0" role="button"
          aria-label="Abrir menú de perfil" pRipple>
          <p-avatar [label]="userInitials" size="large" shape="circle"></p-avatar>
          <div class="flex flex-1 flex-column">
            <span class="font-medium text-900">{{ user.unique_name }}</span>
            <span class="text-sm text-600">{{ user.role }}</span>
          </div>
          <i class="pi pi-ellipsis-v text-600"></i>
        </div>
        <p-menu #profileMenu [model]="profileMenuItems" [popup]="true" appendTo="body"
          [ariaLabel]="'Menú de opciones de perfil'"></p-menu>
      </div>
    </div>
  </ng-template>
</p-sidebar>

<!-- Collapsed vertical bar shown when sidebar is collapsed -->
<div class="collapsed-bar" *ngIf="collapsed" role="navigation" aria-label="Collapsed sidebar">
  <div class="flex h-full flex-column">
    <!-- Logo and expand button in collapsed state -->
    <div class="collapsed-header">
      <img src="../../../assets/img/martinierelogo.png" alt="Martiniere Logo" class="collapsed-logo">
    </div>
    <ul class="flex-1 p-0 m-0 list-none collapsed-list">
      <li>
        <a pRipple [routerLink]="['home']" class="collapsed-item" aria-label="Inicio">
          <i class="pi pi-home"></i>
        </a>
      </li>
      <li *ngIf="canViewDashboard()">
        <a pRipple [routerLink]="['dashboard']" class="collapsed-item" aria-label="Dashboard">
          <i class="pi pi-chart-bar"></i>
        </a>
      </li>
      <li *ngIf="canViewIncidents()">
        <a pRipple [routerLink]="['incidents']" class="collapsed-item" aria-label="Incidencias">
          <i class="pi pi-exclamation-circle"></i>
        </a>
      </li>
      <li *ngIf="canViewProjects()">
        <a pRipple [routerLink]="['projects']" class="collapsed-item" aria-label="Proyectos">
          <i class="pi pi-folder"></i>
        </a>
      </li>
      <li *ngIf="canViewUsers()">
        <a pRipple [routerLink]="['users']" class="collapsed-item" aria-label="Usuarios">
          <i class="pi pi-users"></i>
        </a>
      </li>
      <li *ngIf="canViewAudit()">
        <a pRipple [routerLink]="['audit']" class="collapsed-item" aria-label="Auditoría">
          <i class="pi pi-history"></i>
        </a>
      </li>
      <li *ngIf="canAccessAdmin()">
        <a pRipple [routerLink]="['admin']" class="collapsed-item" aria-label="Administración">
          <i class="pi pi-cog"></i>
        </a>
      </li>
    </ul>

    <!-- Profile avatar in collapsed state -->
    <div class="flex-shrink-0 p-2 cursor-pointer collapsed-profile" *ngIf="currentUser as user"
      (click)="toggleProfileMenu($event)" (keydown.enter)="toggleProfileMenu($event)"
      (keydown.space)="toggleProfileMenu($event); $event.preventDefault()" tabindex="0" role="button"
      aria-label="Abrir menú de perfil">
      <p-avatar [label]="userInitials" styleClass="mx-auto hover:bg-primary-100" size="normal"
        shape="circle"></p-avatar>
    </div>
  </div>
</div>