<p-sidebar #sidebarRef [visible]="!collapsed" [modal]="false" [styleClass]="collapsed ? 'collapsed-sidebar' : ''" (onHide)="toggleCollapsed()">
  <ng-template pTemplate="headless">
    <div class="flex flex-column h-full">
      <div class="flex align-items-center justify-content-between px-4 pt-3 flex-shrink-0">
        <span class="inline-flex align-items-center gap-2">
          <span class="font-semibold text-2xl text-primary"><img src="../../../assets/img/martinierelogo.png" alt="Martiniere Logo"
              width="100px"></span>
        </span>
        <span>
          <p-button type="button" (onClick)="toggleCollapsed()" icon="pi pi-angle-double-left" rounded="true"
            outlined="true" styleClass="h-2rem w-2rem"></p-button>
        </span>
      </div>
      <div class="overflow-y-auto">
        <ul class="list-none p-3 m-0">
          <li>
            <a pRipple [routerLink]="['home']" routerLinkActive="active-menu-item"
              class="flex align-items-center cursor-pointer p-3 border-round text-700 hover:surface-100 transition-duration-150 transition-colors p-ripple">
              <i class="pi pi-home mr-2"></i>
              <span class="font-medium">Inicio</span>
            </a>
          </li>
          <li *ngIf="canViewDashboard()">
            <a pRipple [routerLink]="['dashboard']" routerLinkActive="active-menu-item"
              class="flex align-items-center cursor-pointer p-3 border-round text-700 hover:surface-100 transition-duration-150 transition-colors p-ripple">
              <i class="pi pi-chart-bar mr-2"></i>
              <span class="font-medium">Dashboard</span>
            </a>
          </li>
        </ul>

        <ul class="list-none p-3 m-0" *ngIf="canSeeManagementSection()">
          <li>
            <div pRipple pStyleClass="@next" enterClass="hidden" enterActiveClass="slidedown" leaveToClass="hidden"
              leaveActiveClass="slideup"
              class="p-3 flex align-items-center justify-content-between text-600 cursor-pointer p-ripple">
              <span class="font-medium"><b>Gestión</b></span>
              <i class="pi pi-chevron-down"></i>
            </div>
            <ul class="list-none p-0 m-0 overflow-hidden">
              <li *ngIf="canViewIncidents()">
                <a pRipple [routerLink]="['incidents']" routerLinkActive="active-menu-item"
                  class="flex align-items-center cursor-pointer p-3 border-round text-700 hover:surface-100 transition-duration-150 transition-colors p-ripple">
                  <i class="pi pi-exclamation-circle mr-2"></i>
                  <span class="font-medium">Incidencias</span>
                </a>
              </li>
              <li *ngIf="canViewProjects()">
                <a pRipple [routerLink]="['projects']" routerLinkActive="active-menu-item"
                  class="flex align-items-center cursor-pointer p-3 border-round text-700 hover:surface-100 transition-duration-150 transition-colors p-ripple">
                  <i class="pi pi-folder mr-2"></i>
                  <span class="font-medium">Proyectos</span>
                </a>
              </li>
              <li *ngIf="canViewUsers()">
                <a pRipple [routerLink]="['users']" routerLinkActive="active-menu-item"
                  class="flex align-items-center cursor-pointer p-3 border-round text-700 hover:surface-100 transition-duration-150 transition-colors p-ripple">
                  <i class="pi pi-users mr-2"></i>
                  <span class="font-medium">Usuarios</span>
                </a>
              </li>
            </ul>
          </li>
        </ul>

        <ul class="list-none p-3 m-0" *ngIf="canSeeAdminSection()">
          <li>
            <div pRipple pStyleClass="@next" enterClass="hidden" enterActiveClass="slidedown" leaveToClass="hidden"
              leaveActiveClass="slideup"
              class="p-3 flex align-items-center justify-content-between text-600 cursor-pointer p-ripple">
              <span class="font-medium"><b>Administración</b></span>
              <i class="pi pi-chevron-down"></i>
            </div>
            <ul class="list-none p-0 m-0 overflow-hidden">
              <li *ngIf="canViewAudit()">
                <a pRipple [routerLink]="['audit']" routerLinkActive="active-menu-item"
                  class="flex align-items-center cursor-pointer p-3 border-round text-700 hover:surface-100 transition-duration-150 transition-colors p-ripple">
                  <i class="pi pi-history mr-2"></i>
                  <span class="font-medium">Auditoría</span>
                </a>
              </li>
              <li *ngIf="canAccessAdmin()">
                <a pRipple [routerLink]="['admin']" routerLinkActive="active-menu-item"
                  class="flex align-items-center cursor-pointer p-3 border-round text-700 hover:surface-100 transition-duration-150 transition-colors p-ripple">
                  <i class="pi pi-cog mr-2"></i>
                  <span class="font-medium">Administración del Sistema</span>
                </a>
              </li>
            </ul>
          </li>
        </ul>
      </div>
      <!-- Profile section at bottom -->
      <div class="profile-section border-top-1 border-200 p-3 flex-shrink-0" *ngIf="currentUser as user">
        <div class="flex align-items-center gap-3 cursor-pointer p-2 border-round hover:surface-100 transition-duration-150" 
             (click)="toggleProfileMenu($event)"
             (keydown.enter)="toggleProfileMenu($event)"
             (keydown.space)="toggleProfileMenu($event); $event.preventDefault()"
             tabindex="0"
             role="button"
             aria-label="Abrir menú de perfil"
             pRipple>
          <p-avatar [label]="userInitials" size="large" shape="circle"></p-avatar>
          <div class="flex flex-column flex-1">
            <span class="font-medium text-900">{{ user.unique_name }}</span>
            <span class="text-600 text-sm">{{ user.role }}</span>
          </div>
          <i class="pi pi-ellipsis-v text-600"></i>
        </div>
        <p-menu #profileMenu [model]="profileMenuItems" [popup]="true" appendTo="body" [ariaLabel]="'Menú de opciones de perfil'"></p-menu>
      </div>
    </div>
  </ng-template>
</p-sidebar>

<!-- Collapsed vertical bar shown when sidebar is collapsed -->
<div class="collapsed-bar" *ngIf="collapsed" role="navigation" aria-label="Collapsed sidebar">
  <div class="flex flex-column h-full">
    <ul class="collapsed-list list-none p-0 m-0 flex-1">
      <li>
        <a pRipple [routerLink]="['home']" class="collapsed-item" aria-label="Inicio">
          <i class="pi pi-home"></i>
        </a>
      </li>
      <li *ngIf="canViewDashboard()">
        <a pRipple [routerLink]="['dashboard']" class="collapsed-item" aria-label="Dashboard">
          <i class="pi pi-chart-bar"></i>
        </a>
      </li>
      <li *ngIf="canViewIncidents()">
        <a pRipple [routerLink]="['incidents']" class="collapsed-item" aria-label="Incidencias">
          <i class="pi pi-exclamation-circle"></i>
        </a>
      </li>
      <li *ngIf="canViewProjects()">
        <a pRipple [routerLink]="['projects']" class="collapsed-item" aria-label="Proyectos">
          <i class="pi pi-folder"></i>
        </a>
      </li>
      <li *ngIf="canViewUsers()">
        <a pRipple [routerLink]="['users']" class="collapsed-item" aria-label="Usuarios">
          <i class="pi pi-users"></i>
        </a>
      </li>
      <li *ngIf="canViewAudit()">
        <a pRipple [routerLink]="['audit']" class="collapsed-item" aria-label="Auditoría">
          <i class="pi pi-history"></i>
        </a>
      </li>
      <li *ngIf="canAccessAdmin()">
        <a pRipple [routerLink]="['admin']" class="collapsed-item" aria-label="Administración">
          <i class="pi pi-cog"></i>
        </a>
      </li>
    </ul>
    
    <!-- Profile avatar in collapsed state -->
    <div class="collapsed-profile p-2 flex-shrink-0 cursor-pointer" 
         *ngIf="currentUser as user"
         (click)="toggleProfileMenu($event)"
         (keydown.enter)="toggleProfileMenu($event)"
         (keydown.space)="toggleProfileMenu($event); $event.preventDefault()"
         tabindex="0"
         role="button"
         aria-label="Abrir menú de perfil">
      <p-avatar [label]="userInitials" styleClass="mx-auto hover:bg-primary-100" size="normal" shape="circle"></p-avatar>
    </div>
  </div>
</div>