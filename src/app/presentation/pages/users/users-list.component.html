<div class="container-fluid p-4">
  <p-card>
    <div class="flex justify-content-between align-items-center mb-4">
      <h2 class="m-0">Gestión de Usuarios</h2>
      <p-button 
        *ngIf="canInviteUser()"
        label="Invitar Usuario" 
        icon="pi pi-user-plus" 
        (onClick)="onInviteUser()">
      </p-button>
    </div>

    <p-table 
      [value]="users" 
      [loading]="loading"
      [paginator]="true" 
      [rows]="10"
      [showCurrentPageReport]="true"
      currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} usuarios"
      [rowsPerPageOptions]="[10, 25, 50]"
      styleClass="p-datatable-striped">
      
      <ng-template pTemplate="header">
        <tr>
          <th>Usuario</th>
          <th>Nombre</th>
          <th>Email</th>
          <th>Rol</th>
          <th>Estado</th>
          <th>Fecha Creación</th>
          <th>Acciones</th>
        </tr>
      </ng-template>
      
      <ng-template pTemplate="body" let-user>
        <tr>
          <td>{{ user.username }}</td>
          <td>{{ user.name }}</td>
          <td>{{ user.email }}</td>
          <td>
            <p-tag [value]="user.primaryRole || 'Sin rol'" [severity]="getRoleSeverity(user.primaryRoleCode)"></p-tag>
          </td>
          <td>
            <p-tag [value]="user.isActive ? 'Activo' : 'Inactivo'" [severity]="getStatusSeverity(user.isActive)"></p-tag>
          </td>
          <td>{{ user.createdAt | date:'short' }}</td>
          <td>
            <p-button 
              icon="pi pi-user" 
              [rounded]="true" 
              [text]="true" 
              severity="info"
              (onClick)="onViewProfile(user)"
              pTooltip="Ver perfil"></p-button>
            <p-button 
              *ngIf="canEditUser()"
              icon="pi pi-pencil" 
              [rounded]="true" 
              [text]="true" 
              severity="info"
              (onClick)="onEdit(user)"></p-button>
            <p-button 
              *ngIf="canDeleteUser()"
              icon="pi pi-trash" 
              [rounded]="true" 
              [text]="true" 
              severity="danger"
              (onClick)="onDelete(user)"></p-button>
          </td>
        </tr>
      </ng-template>
      
      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="7" class="text-center">No se encontraron usuarios.</td>
        </tr>
      </ng-template>
    </p-table>
  </p-card>

  <!-- User Invitation Dialog -->
  <p-dialog 
    [(visible)]="displayInvitationDialog" 
    header="Invitar Usuario"
    [modal]="true"
    [style]="{width: '500px'}"
    [closable]="true">
    
    <form #invitationFormRef="ngForm" class="p-fluid">
      <div class="field mb-3">
        <label for="fullName">Nombre Completo *</label>
        <input 
          id="fullName" 
          name="fullName"
          #fullNameField="ngModel"
          type="text" 
          pInputText 
          [(ngModel)]="invitationForm.fullName"
          placeholder="Ingrese el nombre completo"
          required />
        <small class="p-error" *ngIf="fullNameField.invalid && (fullNameField.dirty || fullNameField.touched || submitted)">
          El nombre es requerido
        </small>
      </div>

      <div class="field mb-3">
        <label for="invitationEmail">Email *</label>
        <input 
          id="invitationEmail" 
          name="invitationEmail"
          #invitationEmailField="ngModel"
          type="email" 
          pInputText 
          [(ngModel)]="invitationForm.email"
          placeholder="Ingrese el email"
          required
          email />
        <small class="p-error" *ngIf="invitationEmailField.invalid && (invitationEmailField.dirty || invitationEmailField.touched || submitted)">
          <span *ngIf="invitationEmailField.errors?.['required']">El email es requerido</span>
          <span *ngIf="invitationEmailField.errors?.['email']">El email no es válido</span>
        </small>
      </div>

      <div class="field mb-3">
        <label for="invitationRole">Rol *</label>
        <p-dropdown 
          id="invitationRole"
          name="invitationRole"
          #invitationRoleField="ngModel"
          [options]="roles"
          [(ngModel)]="invitationForm.roleId"
          placeholder="Seleccione un rol"
          optionLabel="label"
          optionValue="value"
          appendTo="body"
          required>
        </p-dropdown>
        <small class="p-error" *ngIf="invitationRoleField.invalid && (invitationRoleField.dirty || invitationRoleField.touched || submitted)">
          El rol es requerido
        </small>
      </div>
    </form>

    <ng-template pTemplate="footer">
      <p-button 
        label="Cancelar" 
        icon="pi pi-times" 
        (onClick)="onCancelInvitationDialog()"
        styleClass="p-button-text">
      </p-button>
      <p-button 
        label="Enviar Invitación" 
        icon="pi pi-send" 
        [loading]="saving"
        [disabled]="saving"
        (onClick)="onSendInvitation()">
      </p-button>
    </ng-template>
  </p-dialog>

  <!-- User Edit Dialog -->
  <p-dialog 
    [(visible)]="displayDialog" 
    header="Editar Usuario"
    [modal]="true"
    [style]="{width: '500px'}"
    [closable]="true">
    
    <form #userFormRef="ngForm" class="p-fluid">
      <div class="field mb-3">
        <label for="name">Nombre Completo *</label>
        <input 
          id="name" 
          name="name"
          #nameField="ngModel"
          type="text" 
          pInputText 
          [(ngModel)]="userForm.name"
          placeholder="Ingrese el nombre completo"
          required />
        <small class="p-error" *ngIf="nameField.invalid && (nameField.dirty || nameField.touched || submitted)">
          El nombre es requerido
        </small>
      </div>

      <div class="field mb-3">
        <label for="username">Usuario *</label>
        <input 
          id="username" 
          name="username"
          #usernameField="ngModel"
          type="text" 
          pInputText 
          [(ngModel)]="userForm.username"
          [disabled]="true"
          placeholder="Ingrese el nombre de usuario"
          required />
        <small class="p-error" *ngIf="usernameField.invalid && (usernameField.dirty || usernameField.touched || submitted)">
          El usuario es requerido
        </small>
      </div>

      <div class="field mb-3">
        <label for="email">Email *</label>
        <input 
          id="email" 
          name="email"
          #emailField="ngModel"
          type="email" 
          pInputText 
          [(ngModel)]="userForm.email"
          placeholder="Ingrese el email"
          required
          email />
        <small class="p-error" *ngIf="emailField.invalid && (emailField.dirty || emailField.touched || submitted)">
          <span *ngIf="emailField.errors?.['required']">El email es requerido</span>
          <span *ngIf="emailField.errors?.['email']">El email no es válido</span>
        </small>
      </div>

      <div class="field mb-3">
        <label for="role">Rol *</label>
        <p-dropdown 
          id="role"
          name="role"
          #roleField="ngModel"
          [options]="roles"
          [(ngModel)]="userForm.roleId"
          placeholder="Seleccione un rol"
          optionLabel="label"
          optionValue="value"
          appendTo="body"
          required>
        </p-dropdown>
        <small class="p-error" *ngIf="roleField.invalid && (roleField.dirty || roleField.touched || submitted)">
          El rol es requerido
        </small>
      </div>

      <div class="field mb-3">
        <div class="flex align-items-center">
          <p-checkbox 
            [(ngModel)]="userForm.isActive"
            name="isActive"
            [binary]="true"
            inputId="active">
          </p-checkbox>
          <label for="active" class="ml-2">Usuario Activo</label>
        </div>
      </div>
    </form>

    <ng-template pTemplate="footer">
      <p-button 
        label="Cancelar" 
        icon="pi pi-times" 
        (onClick)="onCancelDialog()"
        styleClass="p-button-text">
      </p-button>
      <p-button 
        label="Actualizar" 
        icon="pi pi-check" 
        [loading]="saving"
        [disabled]="saving"
        (onClick)="onSaveUser()">
      </p-button>
    </ng-template>
  </p-dialog>

  <!-- Confirmation Dialog -->
  <p-confirmDialog></p-confirmDialog>
</div>
