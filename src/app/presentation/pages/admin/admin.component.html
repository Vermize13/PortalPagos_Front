<div class="container-fluid p-4">
  <p-card>
    <div class="flex justify-content-between align-items-center mb-4">
      <h2 class="m-0">Administración del Sistema</h2>
      <p-button 
        label="RF6.1: Nueva Copia de Seguridad" 
        icon="pi pi-save" 
        (onClick)="openCreateDialog()"
        [disabled]="loading">
      </p-button>
    </div>

    <p-table 
      [value]="backups" 
      [loading]="loading"
      [paginator]="true" 
      [rows]="10"
      [showCurrentPageReport]="true"
      currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} copias de seguridad"
      [rowsPerPageOptions]="[10, 25, 50]"
      styleClass="p-datatable-striped">
      
      <ng-template pTemplate="header">
        <tr>
          <th>ID</th>
          <th>Fecha/Hora</th>
          <th>Creado Por</th>
          <th>Estado</th>
          <th>Tamaño</th>
          <th>Duración</th>
          <th>Notas</th>
          <th>Acciones</th>
        </tr>
      </ng-template>
      
      <ng-template pTemplate="body" let-backup>
        <tr>
          <td>
            <small class="font-mono">{{ backup.id.substring(0, 8) }}...</small>
          </td>
          <td>{{ backup.startedAt | date:'short' }}</td>
          <td>{{ backup.creatorName || 'Sistema' }}</td>
          <td>
            <p-tag 
              [value]="backup.status || 'Completado'" 
              [severity]="getStatusSeverity(backup.status)">
            </p-tag>
          </td>
          <td>{{ formatBytes(backup.sizeBytes) }}</td>
          <td>{{ getDuration(backup.startedAt, backup.finishedAt) }}</td>
          <td>
            <span class="text-sm">{{ backup.notes || '-' }}</span>
          </td>
          <td>
            <p-button 
              label="RF6.2: Restaurar" 
              icon="pi pi-replay" 
              [outlined]="true"
              size="small"
              severity="warning"
              (onClick)="openRestoreDialog(backup)"
              [disabled]="loading">
            </p-button>
          </td>
        </tr>
      </ng-template>
      
      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="8" class="text-center">No hay copias de seguridad disponibles.</td>
        </tr>
      </ng-template>
    </p-table>
  </p-card>
</div>

<!-- Create Backup Dialog -->
<p-dialog 
  header="RF6.1: Crear Copia de Seguridad" 
  [(visible)]="showCreateDialog" 
  [modal]="true"
  [style]="{width: '500px'}"
  [draggable]="false"
  [resizable]="false">
  
  <div class="field">
    <label for="backupNotes" class="block mb-2 font-semibold">Notas</label>
    <textarea 
      id="backupNotes"
      pInputTextarea 
      [(ngModel)]="backupNotes" 
      rows="5" 
      class="w-full"
      placeholder="Ingrese notas sobre esta copia de seguridad (ej: Backup antes de migración)">
    </textarea>
  </div>
  
  <ng-template pTemplate="footer">
    <p-button 
      label="Cancelar" 
      icon="pi pi-times" 
      [outlined]="true"
      (onClick)="showCreateDialog = false">
    </p-button>
    <p-button 
      label="Crear Backup" 
      icon="pi pi-save" 
      (onClick)="createBackup()"
      [loading]="loading">
    </p-button>
  </ng-template>
</p-dialog>

<!-- Restore Backup Dialog -->
<p-dialog 
  header="RF6.2: Restaurar Copia de Seguridad" 
  [(visible)]="showRestoreDialog" 
  [modal]="true"
  [style]="{width: '500px'}"
  [draggable]="false"
  [resizable]="false">
  
  <div class="mb-4">
    <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4">
      <div class="flex">
        <div class="flex-shrink-0">
          <i class="pi pi-exclamation-triangle text-yellow-400"></i>
        </div>
        <div class="ml-3">
          <p class="text-sm text-yellow-700">
            <strong>Advertencia:</strong> Esta acción restaurará la base de datos al estado de la copia de seguridad seleccionada. 
            Todos los cambios realizados después de esa fecha se perderán.
          </p>
        </div>
      </div>
    </div>
    
    <div *ngIf="selectedBackup" class="mb-3">
      <p><strong>Backup ID:</strong> {{ selectedBackup.id }}</p>
      <p><strong>Fecha:</strong> {{ selectedBackup.startedAt | date:'medium' }}</p>
      <p><strong>Tamaño:</strong> {{ formatBytes(selectedBackup.sizeBytes) }}</p>
      <p><strong>Creado por:</strong> {{ selectedBackup.creatorName || 'Sistema' }}</p>
    </div>
  </div>
  
  <div class="field">
    <label for="restoreNotes" class="block mb-2 font-semibold">Notas de Restauración</label>
    <textarea 
      id="restoreNotes"
      pInputTextarea 
      [(ngModel)]="restoreNotes" 
      rows="3" 
      class="w-full"
      placeholder="Ingrese el motivo de la restauración (opcional)">
    </textarea>
  </div>
  
  <ng-template pTemplate="footer">
    <p-button 
      label="Cancelar" 
      icon="pi pi-times" 
      [outlined]="true"
      (onClick)="showRestoreDialog = false">
    </p-button>
    <p-button 
      label="Restaurar" 
      icon="pi pi-replay" 
      severity="warning"
      (onClick)="restoreBackup()"
      [loading]="loading">
    </p-button>
  </ng-template>
</p-dialog>
