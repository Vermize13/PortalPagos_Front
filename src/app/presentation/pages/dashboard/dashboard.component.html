<div class="p-4 container-fluid">
  <div class="flex mb-4 justify-content-between align-items-center">
    <h1 class="m-0">Dashboard - Sistema de Gestión de Incidencias</h1>
    <div class="flex gap-2 align-items-center">
      <span class="font-medium text-gray-600">Filtrar por proyecto:</span>
      <p-dropdown [options]="projects" [(ngModel)]="selectedProjectId" placeholder="Todos los proyectos"
        [showClear]="true" optionLabel="label" optionValue="value" (onChange)="onFilterByProject()"
        [style]="{'min-width': '250px'}">
      </p-dropdown>
    </div>
  </div>

  <!-- RF4: Dashboard Metrics Summary Cards -->
  <div class="grid">
    <div class="col-12 md:col-6 lg:col-3">
      <p-card>
        <div class="text-center">
          <i class="text-4xl text-blue-500 pi pi-exclamation-circle"></i>
          <h3 class="mt-2">Incidencias Abiertas</h3>
          <p class="text-3xl font-bold">{{ metrics?.openIncidents || 0 }}</p>
        </div>
      </p-card>
    </div>

    <div class="col-12 md:col-6 lg:col-3">
      <p-card>
        <div class="text-center">
          <i class="text-4xl text-green-500 pi pi-check-circle"></i>
          <h3 class="mt-2">Incidencias Cerradas</h3>
          <p class="text-3xl font-bold">{{ metrics?.closedIncidents || 0 }}</p>
        </div>
      </p-card>
    </div>

    <div class="col-12 md:col-6 lg:col-3">
      <p-card>
        <div class="text-center">
          <i class="text-4xl text-orange-500 pi pi-sync"></i>
          <h3 class="mt-2">En Progreso</h3>
          <p class="text-3xl font-bold">{{ metrics?.inProgressIncidents || 0 }}</p>
        </div>
      </p-card>
    </div>
  </div>

  <!-- RF4.1: Charts by Status, Priority, and Severity -->
  <div class="grid mt-4">
    <div class="col-12 lg:col-4">
      <p-card header="Incidencias por Estado">
        <p-chart type="doughnut" [data]="statusChartData" [options]="chartOptions" height="300px"></p-chart>
      </p-card>
    </div>

    <div class="col-12 lg:col-4">
      <p-card header="Incidencias por Prioridad">
        <p-chart type="pie" [data]="priorityChartData" [options]="chartOptions" height="300px"></p-chart>
      </p-card>
    </div>

    <div class="col-12 lg:col-4">
      <p-card header="Incidencias por Severidad">
        <p-chart type="polarArea" [data]="severityChartData" [options]="chartOptions" height="300px"></p-chart>
      </p-card>
    </div>
  </div>

  <!-- RF4.3: Incident Evolution Chart -->
  <div class="grid mt-4">
    <div class="col-12">
      <p-card header="Evolución de Incidencias (Últimos 30 días)">
        <p-chart type="line" [data]="evolutionChartData" [options]="chartOptions" height="300px"></p-chart>
      </p-card>
    </div>
  </div>

  <!-- RF4.2: Incidents by Sprint Table -->
  <div class="grid mt-4">
    <div class="col-12">
      <p-card header="Incidencias por Sprint">
        <p-table [value]="metrics?.incidentsBySprint || []" [loading]="loading">
          <ng-template pTemplate="header">
            <tr>
              <th>Sprint</th>
              <th>Abiertas</th>
              <th>Cerradas</th>
              <th>Total</th>
              <th>Progreso</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-sprint>
            <tr>
              <td>{{ sprint.sprintName }}</td>
              <td>
                <span class="px-2 py-1 text-white bg-blue-500 rounded badge">{{ sprint.openCount }}</span>
              </td>
              <td>
                <span class="px-2 py-1 text-white bg-green-500 rounded badge">{{ sprint.closedCount }}</span>
              </td>
              <td>{{ sprint.totalCount }}</td>
              <td>
                <div class="w-full bg-gray-200 rounded-full h-2.5">
                  <div class="bg-green-600 h-2.5 rounded-full"
                    [style.width.%]="sprint.totalCount > 0 ? (sprint.closedCount / sprint.totalCount * 100) : 0">
                  </div>
                </div>
                <small class="text-gray-600">
                  {{ sprint.totalCount > 0 ? ((sprint.closedCount / sprint.totalCount * 100) | number:'1.0-0') : 0 }}%
                </small>
              </td>
            </tr>
          </ng-template>
          <ng-template pTemplate="emptymessage">
            <tr>
              <td colspan="5" class="text-center">No hay datos de sprints disponibles</td>
            </tr>
          </ng-template>
        </p-table>
      </p-card>
    </div>
  </div>
</div>