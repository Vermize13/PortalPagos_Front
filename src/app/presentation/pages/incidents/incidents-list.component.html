<div class="container-fluid p-4">
  <p-card>
    <div class="flex justify-content-between align-items-center mb-4">
      <h2 class="m-0">Gestión de Incidencias</h2>
      <div class="flex gap-2">
        <p-button 
          label="Tablero" 
          icon="pi pi-th-large" 
          [outlined]="viewMode !== 'board'"
          (onClick)="toggleView('board')"></p-button>
        <p-button 
          label="Tabla" 
          icon="pi pi-table" 
          [outlined]="viewMode !== 'table'"
          (onClick)="toggleView('table')"></p-button>
        <p-button 
          label="Nueva Incidencia" 
          icon="pi pi-plus" 
          (onClick)="onCreate()"></p-button>
      </div>
    </div>

    <div class="mb-3 flex gap-2" *ngIf="viewMode === 'table'">
      <p-dropdown 
        [options]="projects" 
        [(ngModel)]="selectedProjectId" 
        placeholder="Filtrar por proyecto"
        [showClear]="true"
        optionLabel="label"
        optionValue="value"
        (onChange)="onFilterByProject()">
      </p-dropdown>
      <p-dropdown 
        *ngIf="selectedProjectId && sprints.length > 0"
        [options]="sprints" 
        [(ngModel)]="selectedSprintId" 
        placeholder="Filtrar por sprint"
        [showClear]="true"
        optionLabel="label"
        optionValue="value"
        (onChange)="onFilterBySprint()">
      </p-dropdown>
      <p-dropdown 
        [options]="statuses" 
        [(ngModel)]="selectedStatus" 
        placeholder="Filtrar por estado"
        [showClear]="true"
        (onChange)="onFilterByStatus()">
      </p-dropdown>
    </div>

    <!-- Board View -->
    <div *ngIf="viewMode === 'board'" class="board-container">
      <div class="board-columns">
        <div class="board-column" 
             *ngFor="let status of statuses"
             (dragover)="onDragOver($event)"
             (drop)="onDrop($event, status)">
          <div class="column-header">
            <h3 class="column-title">{{ getStatusLabel(status) }}</h3>
            <span class="incident-count">{{ getIncidentsByStatus(status).length }}</span>
          </div>
          <div class="column-content">
            <div class="incident-card" 
                 *ngFor="let incident of getIncidentsByStatus(status)"
                 draggable="true"
                 (dragstart)="onDragStart($event, incident)"
                 (dragend)="onDragEnd($event)">
              <div class="card-header">
                <span class="incident-code">{{ incident.code }}</span>
                <p-tag 
                  [value]="incident.priorityLabel" 
                  [severity]="getPrioritySeverity(incident.priority)"
                  styleClass="text-xs"></p-tag>
              </div>
              <h4 class="card-title">{{ incident.title }}</h4>
              <p class="card-description">{{ incident.description | slice:0:80 }}{{ incident.description && incident.description.length > 80 ? '...' : '' }}</p>
              
              <!-- Labels Display -->
              <div class="card-labels mb-2" *ngIf="incident.labels && incident.labels.length > 0">
                <p-tag 
                  *ngFor="let label of incident.labels" 
                  [value]="label.name"
                  [style]="{'background-color': label.colorHex || '#6c757d', 'color': '#fff'}"
                  styleClass="text-xs mr-1"></p-tag>
              </div>
              
              <div class="card-footer">
                <div class="card-meta">
                  <div class="reporter" *ngIf="incident.reporterName">
                    <i class="pi pi-user-plus"></i>
                    <span>{{ incident.reporterName }}</span>
                  </div>
                  <div class="assignee" *ngIf="incident.assigneeName">
                    <i class="pi pi-user"></i>
                    <span>{{ incident.assigneeName }}</span>
                  </div>
                  <div class="project">
                    <i class="pi pi-briefcase"></i>
                    <span>{{ incident.projectName }}</span>
                  </div>
                </div>
                <div class="card-actions">
                  <p-button 
                    icon="pi pi-eye" 
                    [rounded]="true" 
                    [text]="true" 
                    severity="secondary"
                    size="small"
                    (onClick)="onViewDetails(incident)"></p-button>
                  <p-button 
                    icon="pi pi-pencil" 
                    [rounded]="true" 
                    [text]="true" 
                    severity="info"
                    size="small"
                    (onClick)="onEdit(incident)"></p-button>
                </div>
              </div>
            </div>
            <div class="empty-column" *ngIf="getIncidentsByStatus(status).length === 0">
              <i class="pi pi-inbox"></i>
              <p>No hay incidencias</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Table View -->
    <p-table *ngIf="viewMode === 'table'" 
      [value]="incidents" 
      [loading]="loading"
      [paginator]="true" 
      [rows]="10"
      [showCurrentPageReport]="true"
      currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} incidencias"
      [rowsPerPageOptions]="[10, 25, 50]"
      styleClass="p-datatable-striped">
      
      <ng-template pTemplate="header">
        <tr>
          <th>ID</th>
          <th>Título</th>
          <th>Etiquetas</th>
          <th>Proyecto</th>
          <th>Estado</th>
          <th>Prioridad</th>
          <th>Reportado por</th>
          <th>Asignado a</th>
          <th>Creado</th>
          <th>Acciones</th>
        </tr>
      </ng-template>
      
      <ng-template pTemplate="body" let-incident>
        <tr>
          <td>{{ incident.code }}</td>
          <td>
            <div class="font-semibold">{{ incident.title }}</div>
            <div class="text-sm text-gray-500">{{ incident.description | slice:0:50 }}...</div>
          </td>
          <td>
            <div class="flex flex-wrap gap-1">
              <p-tag 
                *ngFor="let label of incident.labels" 
                [value]="label.name"
                [style]="{'background-color': label.colorHex || '#6c757d', 'color': '#fff'}"
                styleClass="text-xs"></p-tag>
              <span *ngIf="!incident.labels || incident.labels.length === 0" class="text-sm text-gray-400">-</span>
            </div>
          </td>
          <td>{{ incident.projectName }}</td>
          <td>
            <p-tag [value]="incident.statusLabel" [severity]="getStatusSeverity(incident.status)"></p-tag>
          </td>
          <td>
            <p-tag [value]="incident.priorityLabel" [severity]="getPrioritySeverity(incident.priority)"></p-tag>
          </td>
          <td>{{ incident.reporterName || 'N/A' }}</td>
          <td>{{ incident.assigneeName || 'Sin asignar' }}</td>
          <td>{{ incident.createdAt | date:'short' }}</td>
          <td>
            <p-button 
              icon="pi pi-eye" 
              [rounded]="true" 
              [text]="true" 
              severity="secondary"
              (onClick)="onViewDetails(incident)"></p-button>
            <p-button 
              icon="pi pi-pencil" 
              [rounded]="true" 
              [text]="true" 
              severity="info"
              (onClick)="onEdit(incident)"></p-button>
            <p-button 
              icon="pi pi-trash" 
              [rounded]="true" 
              [text]="true" 
              severity="danger"
              (onClick)="onDelete(incident)"></p-button>
          </td>
        </tr>
      </ng-template>
      
      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="10" class="text-center">No se encontraron incidencias.</td>
        </tr>
      </ng-template>
    </p-table>
  </p-card>

  <!-- Incident Create/Edit Dialog -->
  <p-dialog 
    [(visible)]="displayDialog" 
    [header]="isEditMode ? 'Editar Incidencia' : 'Nueva Incidencia'"
    [modal]="true"
    [style]="{width: '730px'}"
    [baseZIndex]="10"
    [closable]="true">
    
    <form #incidentFormRef="ngForm" class="p-fluid">
      <div class="field mb-3">
        <label for="project">Proyecto *</label>
        <p-dropdown 
          id="project"
          name="project"
          #projectField="ngModel"
          [options]="projects"
          [(ngModel)]="incidentForm.projectId"
          name="projectId"
          (onChange)="onProjectChange($event.value)"
          placeholder="Seleccione un proyecto"
          [disabled]="isEditMode"
          optionLabel="label"
          optionValue="value"
          required>
        </p-dropdown>
        <small class="p-error" *ngIf="projectField.invalid && (projectField.dirty || projectField.touched || submitted)">
          El proyecto es requerido
        </small>
      </div>

      <div class="field mb-3" *ngIf="incidentForm.projectId && sprints.length > 0">
        <label for="sprint">Sprint</label>
        <p-dropdown 
          id="sprint"
          name="sprint"
          [options]="sprints"
          [(ngModel)]="incidentForm.sprintId"
          placeholder="Seleccione un sprint (opcional)"
          [showClear]="true"
          optionLabel="label"
          optionValue="value">
        </p-dropdown>
      </div>

      <div class="field mb-3">
        <label for="title">Título *</label>
        <input 
          id="title" 
          name="title"
          #titleField="ngModel"
          type="text" 
          pInputText 
          [(ngModel)]="incidentForm.title"
          placeholder="Título de la incidencia"
          required />
        <small class="p-error" *ngIf="titleField.invalid && (titleField.dirty || titleField.touched || submitted)">
          El título es requerido
        </small>
      </div>

      <div class="field mb-3">
        <label for="description">Descripción</label>
        <textarea 
          id="description"
          name="description"
          #descriptionField="ngModel" 
          pInputTextarea 
          [(ngModel)]="incidentForm.description"
          placeholder="Descripción detallada de la incidencia"
          rows="4">
        </textarea>
      </div>

      <div class="grid">
        <div class="col-6">
          <div class="field mb-3">
            <label for="severity">Severidad *</label>
            <p-dropdown 
              id="severity"
              name="severity"
              #severityField="ngModel"
              [options]="severities"
              [(ngModel)]="incidentForm.severity"
              placeholder="Seleccione severidad"
              appendTo="body"
              optionLabel="label"
              optionValue="value"
              required>
            </p-dropdown>
            <small class="p-error" *ngIf="severityField.invalid && (severityField.dirty || severityField.touched || submitted)">
              La severidad es requerida
            </small>
          </div>
        </div>

        <div class="col-6">
          <div class="field mb-3">
            <label for="priority">Prioridad *</label>
            <p-dropdown 
              id="priority"
              name="priority"
              #priorityField="ngModel"
              [options]="priorities"
              [(ngModel)]="incidentForm.priority"
              placeholder="Seleccione prioridad"
              optionLabel="label"
              appendTo="body"
              optionValue="value"
              required>
            </p-dropdown>
            <small class="p-error" *ngIf="priorityField.invalid && (priorityField.dirty || priorityField.touched || submitted)">
              La prioridad es requerida
            </small>
          </div>
        </div>
      </div>

      <div class="grid" *ngIf="isEditMode">
        <div class="col-12">
          <div class="field mb-3">
            <label for="status">Estado *</label>
            <p-dropdown 
              id="status"
              [options]="statusOptions"
              [(ngModel)]="incidentForm.status"
              placeholder="Seleccione estado"
              appendTo="body"
              optionLabel="label"
              optionValue="value">
            </p-dropdown>
          </div>
        </div>
      </div>

      <div class="field mb-3" *ngIf="!isEditMode && incidentForm.projectId && labels.length > 0">
        <label for="labels">Etiquetas</label>
        <p-multiSelect 
          id="labels"
          name="labels"
          #labelsField="ngModel"
          [options]="labels"
          [(ngModel)]="incidentForm.labelIds"
          placeholder="Seleccione etiquetas"
          [showClear]="true"
          appendTo="body"
          optionLabel="name"
          optionValue="id"
          [style]="{'width': '100%'}">
          <ng-template let-label pTemplate="item">
            <div class="flex align-items-center gap-2">
              <span 
                class="label-color-indicator" 
                [style.background-color]="label.colorHex || '#6c757d'">
              </span>
              <span>{{ label.name }}</span>
            </div>
          </ng-template>
          <ng-template let-label pTemplate="selectedItem">
            <p-tag 
              [value]="label.name"
              [style]="{'background-color': label.colorHex || '#6c757d', 'color': '#fff'}"
              styleClass="text-xs mr-1">
            </p-tag>
          </ng-template>
        </p-multiSelect>
        <small class="text-gray-500">Puede seleccionar múltiples etiquetas</small>
      </div>

      <div class="grid">
        <div class="col-6">
          <div class="field mb-3">
            <label for="assignee">Asignado a</label>
            <p-dropdown 
              id="assignee"
              name="assignee"
              #assigneeField="ngModel"
              [options]="projectMembers"
              [(ngModel)]="incidentForm.assigneeId"
              placeholder="Seleccione un miembro del proyecto"
              [showClear]="true"
              [disabled]="!incidentForm.projectId || projectMembers.length === 0"
              appendTo="body"
              optionLabel="label"
              optionValue="value">
            </p-dropdown>
            <small class="text-gray-500" *ngIf="incidentForm.projectId && projectMembers.length === 0">
              No hay miembros en este proyecto
            </small>
            <small class="text-gray-500" *ngIf="!incidentForm.projectId">
              Primero seleccione un proyecto
            </small>
          </div>
        </div>

        <div class="col-6">
          <div class="field mb-3">
            <label for="dueDate">Fecha Límite</label>
            <p-calendar 
              id="dueDate"
              name="dueDate"
              #dueDateField="ngModel"
              [(ngModel)]="incidentForm.dueDate"
              [showIcon]="true"
              placeholder="Seleccione fecha"
              appendTo="body"
              [minDate]="minDate"
              [maxDate]="maxDate"
              dateFormat="dd/mm/yy">
            </p-calendar>
          </div>
        </div>
      </div>
    </form>

    <ng-template pTemplate="footer">
      <p-button 
        label="Cancelar" 
        icon="pi pi-times" 
        (onClick)="onCancelDialog()"
        styleClass="p-button-text">
      </p-button>
      <p-button 
        [label]="isEditMode ? 'Actualizar' : 'Crear'" 
        icon="pi pi-check" 
        (onClick)="onSaveIncident()">
      </p-button>
    </ng-template>
  </p-dialog>

  <!-- Confirmation Dialog -->
  <p-confirmDialog></p-confirmDialog>
</div>
